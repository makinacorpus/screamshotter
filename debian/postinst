#!/bin/sh -e

# set -x
# export DEBCONF_DEBUG=developer

# Source debconf library.
. /usr/share/debconf/confmodule

# Create screamshotter user (only on a new install)
if [ "$2" = "" ]; then
	adduser --system --group --no-create-home --quiet screamshotter || true
fi

db_get screamshotter/TIMEOUT; export TIMEOUT="$RET"
db_get screamshotter/SENTRY_DSN; export SENTRY_DSN="$RET"
db_get screamshotter/SENTRY_ENVIRONMENT; export SENTRY_ENVIRONMENT="$RET"
db_get screamshotter/SENTRY_TRACE_SAMPLE; export SENTRY_TRACE_SAMPLE="$RET"

mkdir -p /opt/screamshotter/static || true
chown -R screamshotter:screamshotter /opt/screamshotter/static || true

# Generate config files
echo "Generate configuration" >&2
CONF_DIR=/opt/screamshotter/conf
for f in custom.py env gunicorn-screamshotter.conf.py; do
	cat > $CONF_DIR/$f << END

# Generated by dpkg installation. DO NOT MODIFY MANUALLY.
# Instead, run "sudo dpkg-reconfigure screamshotter"
# or edit /opt/screamshotter/conf/$f.in
END
  	envsubst < $CONF_DIR/$f.in >> $CONF_DIR/$f
  	chown screamshotter.screamshotter $CONF_DIR/$f || true
done

screamshotter collectstatic --no-input

#DEBHELPER#
